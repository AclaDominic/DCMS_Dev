import{r as l,j as e}from"./react-vendor-CldNo62R.js";import{a as u}from"./index-CXcsw-fJ.js";import"./vendor-BEvxFShY.js";import"./chart-vendor-DBbN5bIf.js";import"./bootstrap-vendor-bmQ-0gGD.js";import"./pdf-vendor-CYotqeJP.js";import"./excel-vendor-_AGFPScu.js";function He({visit:o,onClose:A,onComplete:E}){var ae,le,ie,ne,ce,re;const[p,D]=l.useState(1),[$,T]=l.useState([]),[r,C]=l.useState([]),[F,f]=l.useState(!1),[P,S]=l.useState(!1),[R,b]=l.useState(""),[I,H]=l.useState(""),[v,m]=l.useState(""),[y,g]=l.useState(""),[_,ee]=l.useState(null),[O,N]=l.useState("paid"),[V,k]=l.useState(""),[z,te]=l.useState("");l.useEffect(()=>{Q(),pe()},[]);const Q=async()=>{try{const i=await u.get("/api/inventory/items");T(i.data.data||[])}catch(i){console.error("Failed to load inventory items",i)}},pe=async()=>{var i,j;try{const d=(await u.get(`/api/visits/${o.id}/dentist-notes`)).data;d.dentist_notes&&b(d.dentist_notes),d.findings&&H(d.findings),d.treatment_plan&&m(d.treatment_plan),d.teeth_treated&&g(d.teeth_treated),(d.created_by||d.created_at)&&ee({created_by:d.created_by,created_at:d.created_at,updated_by:d.updated_by,updated_at:d.updated_at})}catch(h){console.log("No dentist notes found or error fetching notes:",(j=(i=h==null?void 0:h.response)==null?void 0:i.data)==null?void 0:j.message)}},Z=()=>{C([...r,{item_id:"",quantity:"",notes:""}])},K=(i,j,h)=>{const d=[...r];d[i][j]=h,C(d)},se=i=>{C(r.filter((j,h)=>h!==i))},G=async()=>{var i,j;S(!0);try{const h={stock_items:r.filter(d=>d.item_id&&d.quantity),dentist_notes:R,findings:I,treatment_plan:v,teeth_treated:y,payment_status:q?"paid":O,onsite_payment_amount:q?null:V?Number(V):null,payment_method_change:q?null:z||null};await u.post(`/api/visits/${o.id}/complete-with-details`,h);try{const d=await u.post(`/api/receipts/visit/${o.id}/email`,{},{skip401Handler:!0});d.data.note?alert(`Visit completed successfully!

${d.data.message}

${d.data.note}`):alert(`Visit completed successfully!

Receipt sent to: ${d.data.email}`)}catch(d){console.error("Failed to send receipt email:",d),alert(`Visit completed successfully!

Note: Receipt email could not be sent. Patient can download receipt from their appointments page.`)}E(),A()}catch(h){alert(((j=(i=h==null?void 0:h.response)==null?void 0:i.data)==null?void 0:j.message)||"Failed to complete visit")}finally{S(!1)}},Y=((ae=o.payments)==null?void 0:ae.reduce((i,j)=>i+(j.amount_paid||0),0))||0,W=((le=o.service)==null?void 0:le.price)||0,L=W-Y,X=(ie=o.payments)==null?void 0:ie.find(i=>i.method==="maya"&&i.status==="paid"),q=!!X;return e.jsx("div",{className:"modal fade show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1050,overflowY:"auto",display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem"},tabIndex:"-1",role:"dialog",children:e.jsx("div",{className:"modal-dialog modal-lg",role:"document",style:{maxWidth:"800px",maxHeight:"calc(100vh - 2rem)",margin:"0 auto",width:"100%"},children:e.jsxs("div",{className:"modal-content d-flex flex-column",style:{maxHeight:"calc(100vh - 2rem)",overflow:"hidden"},children:[e.jsxs("div",{className:"modal-header bg-primary text-white py-2 flex-shrink-0",style:{position:"sticky",top:0,zIndex:1,borderBottom:"1px solid #dee2e6"},children:[e.jsxs("h5",{className:"modal-title fw-bold mb-0",children:[e.jsx("i",{className:"fas fa-check-circle me-2"}),"Complete Visit"]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:A,"aria-label":"Close",style:{fontSize:"1.2rem"}})]}),e.jsxs("div",{className:"modal-body p-3 flex-grow-1",style:{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:0},children:[e.jsx("div",{className:"d-flex justify-content-center mb-3",children:e.jsx("div",{className:"progress w-100",style:{height:"4px"},children:e.jsx("div",{className:"progress-bar bg-primary",role:"progressbar",style:{width:`${p/3*100}%`},"aria-valuenow":p,"aria-valuemin":"0","aria-valuemax":"3"})})}),e.jsx("div",{className:"d-flex justify-content-between mb-3",children:[1,2,3].map(i=>e.jsxs("div",{className:"d-flex flex-column align-items-center",children:[e.jsx("div",{className:`rounded-circle d-flex align-items-center justify-content-center mb-1 ${p>=i?"bg-primary text-white shadow-sm":"bg-light text-muted border"}`,style:{width:"36px",height:"36px",fontSize:"14px"},children:e.jsx("i",{className:`fas ${i===1?"fa-boxes":i===2?"fa-sticky-note":"fa-credit-card"}`})}),e.jsxs("small",{className:`text-center ${p>=i?"text-primary fw-bold":"text-muted"}`,style:{fontSize:"12px"},children:[i===1&&"Stock",i===2&&"Notes",i===3&&"Payment"]})]},i))}),p===1&&e.jsxs("div",{className:"card border-0 shadow-sm",children:[e.jsx("div",{className:"card-header bg-gradient bg-light py-2",children:e.jsxs("h6",{className:"card-title mb-0",children:[e.jsx("i",{className:"fas fa-boxes text-primary me-2"}),"Consume Stock Items"]})}),e.jsxs("div",{className:"card-body p-3",children:[r.length>0?e.jsx("div",{className:"row g-2",children:r.map((i,j)=>e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"card border border-primary border-opacity-25",children:e.jsx("div",{className:"card-body p-2",children:e.jsxs("div",{className:"row g-2 align-items-end",children:[e.jsx("div",{className:"col-md-4",children:e.jsxs("select",{className:"form-select",value:i.item_id,onChange:h=>K(j,"item_id",h.target.value),children:[e.jsx("option",{value:"",children:"Item"}),$.map(h=>e.jsxs("option",{value:h.id,children:[h.name," (Stock: ",h.total_on_hand||0,")"]},h.id))]})}),e.jsx("div",{className:"col-md-2",children:e.jsx("input",{type:"number",step:"0.01",min:"0",className:"form-control",value:i.quantity,onChange:h=>K(j,"quantity",h.target.value),placeholder:"Quantity"})}),e.jsx("div",{className:"col-md-4",children:e.jsx("input",{type:"text",className:"form-control",value:i.notes,onChange:h=>K(j,"notes",h.target.value),placeholder:"Notes"})}),e.jsx("div",{className:"col-md-2",children:e.jsxs("button",{type:"button",onClick:()=>se(j),className:"btn btn-outline-danger w-100",title:"Remove item",style:{minHeight:"38px"},children:[e.jsx("i",{className:"fas fa-trash me-1"}),"Remove Item"]})})]})})})},j))}):e.jsxs("div",{className:"text-center py-4 text-muted",children:[e.jsx("i",{className:"fas fa-boxes fa-3x mb-3 text-primary opacity-50"}),e.jsx("p",{className:"mb-0",children:"No stock items added yet"}),e.jsx("small",{children:'Click "Add Item" to start consuming stock'})]}),e.jsx("div",{className:"mt-3 text-center",children:e.jsxs("button",{type:"button",onClick:Z,className:"btn btn-primary",style:{minWidth:"120px"},children:[e.jsx("i",{className:"fas fa-plus me-2"}),"Add Item"]})})]})]}),p===2&&e.jsxs("div",{className:"card border-0 shadow-sm",children:[e.jsx("div",{className:"card-header bg-gradient bg-light py-2",children:e.jsxs("h6",{className:"card-title mb-0",children:[e.jsx("i",{className:"fas fa-sticky-note text-primary me-2"}),"Visit Documentation"]})}),e.jsxs("div",{className:"card-body p-3",children:[_&&e.jsxs("div",{className:"alert alert-info mb-3 py-2 border-0",children:[e.jsxs("h6",{className:"alert-heading small",children:[e.jsx("i",{className:"fas fa-info-circle me-2"}),"Original Notes Information"]}),e.jsxs("p",{className:"mb-1 small",children:[e.jsx("strong",{children:"Created by:"})," ",_.created_by," on ",new Date(_.created_at).toLocaleString()]}),_.updated_by&&_.updated_at&&e.jsxs("p",{className:"mb-1 small",children:[e.jsx("strong",{children:"Last updated by:"})," ",_.updated_by," on ",new Date(_.updated_at).toLocaleString()]}),e.jsx("hr",{className:"my-2"}),e.jsx("p",{className:"mb-0 small",children:"You can edit these notes as needed for the final documentation."})]}),e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-user-md text-primary me-1"}),"Dentist Notes"]}),e.jsx("textarea",{className:"form-control",rows:"3",value:R,onChange:i=>b(i.target.value),placeholder:"Enter dentist's notes about the visit..."})]}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-search text-primary me-1"}),"Findings"]}),e.jsx("textarea",{className:"form-control",rows:"3",value:I,onChange:i=>H(i.target.value),placeholder:"Document any findings or observations..."})]}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-clipboard-list text-primary me-1"}),"Treatment Plan"]}),e.jsx("textarea",{className:"form-control",rows:"3",value:v,onChange:i=>m(i.target.value),placeholder:"Outline the treatment plan or follow-up instructions..."})]}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-tooth text-primary me-1"}),"Teeth Treated"]}),e.jsx("input",{type:"text",className:"form-control",value:y,onChange:i=>g(i.target.value),placeholder:"e.g., 1,2,3,4,5 or leave blank if not applicable"}),e.jsx("div",{className:"form-text",children:"Enter tooth numbers separated by commas (e.g., 1,2,3,4,5). Use the Universal Numbering System."})]})]})]})]}),p===3&&e.jsxs("div",{className:"card border-0 shadow-sm",children:[e.jsx("div",{className:"card-header bg-gradient bg-light py-2",children:e.jsxs("h6",{className:"card-title mb-0",children:[e.jsx("i",{className:"fas fa-credit-card text-primary me-2"}),"Payment Verification"]})}),e.jsx("div",{className:"card-body p-3",children:e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"card border-0 shadow-sm",style:{background:"linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)"},children:e.jsxs("div",{className:"card-body p-3",children:[e.jsxs("h6",{className:"card-title text-dark mb-3",children:[e.jsx("i",{className:"fas fa-receipt text-primary me-2"}),"Payment Summary"]}),e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Service"}),e.jsx("div",{className:"fw-semibold text-dark",children:((ne=o.service)==null?void 0:ne.name)||"N/A"})]})}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Service Price"}),e.jsxs("div",{className:"fw-semibold text-primary",children:["â‚±",W.toLocaleString(),((ce=o.service)==null?void 0:ce.per_teeth_service)&&e.jsx("small",{className:"text-info d-block",children:"per tooth"})]})]})}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Total Paid"}),e.jsxs("div",{className:"fw-semibold text-success",children:["â‚±",Y.toLocaleString()]})]})}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Balance"}),e.jsxs("div",{className:`fw-bold ${L>0?"text-warning":"text-success"}`,children:["â‚±",L.toLocaleString()]})]})})]})]})})}),q&&e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"alert alert-success border-0 shadow-sm",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("i",{className:"fas fa-check-circle fa-2x text-success me-3"}),e.jsxs("div",{children:[e.jsxs("h6",{className:"alert-heading mb-1",children:[e.jsx("i",{className:"fas fa-credit-card me-2"}),"Maya Payment Completed"]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Amount Paid:"})," â‚±",(re=X.amount_paid)==null?void 0:re.toLocaleString()]}),e.jsxs("p",{className:"mb-0",children:[e.jsx("strong",{children:"Payment Date:"})," ",new Date(X.paid_at).toLocaleString()]}),e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"fas fa-lock me-1"}),"Payment information is read-only as the Maya payment has been successfully completed."]})]})]})})}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-credit-card text-primary me-1"}),"Payment Status"]}),e.jsxs("select",{className:"form-select",value:O,onChange:i=>N(i.target.value),disabled:q,children:[e.jsx("option",{value:"paid",children:"Fully Paid"}),e.jsx("option",{value:"hmo_fully_covered",children:"HMO Fully Covered"}),e.jsx("option",{value:"partial",children:"Partially Paid (HMO didn't cover all)"}),e.jsx("option",{value:"unpaid",children:"Unpaid (Maya failed)"})]}),q&&e.jsxs("div",{className:"form-text text-muted",children:[e.jsx("i",{className:"fas fa-lock me-1"}),"Payment status cannot be changed as Maya payment is already completed."]})]}),O==="partial"&&!q&&e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-money-bill text-primary me-1"}),"On-site Payment Amount (â‚±)"]}),e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:"â‚±"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:L,className:"form-control",value:V,onChange:i=>k(i.target.value),placeholder:`Maximum: ${L.toLocaleString()}`})]}),e.jsxs("div",{className:"form-text",children:["Maximum amount: â‚±",L.toLocaleString()]})]}),O==="unpaid"&&!q&&e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-exchange-alt text-primary me-1"}),"Payment Method Change"]}),e.jsxs("select",{className:"form-select",value:z,onChange:i=>te(i.target.value),children:[e.jsx("option",{value:"",children:"Select change"}),e.jsx("option",{value:"maya_to_cash",children:"Change Maya to Cash Payment"})]})]})]})})]})]}),e.jsx("div",{className:"modal-footer bg-light border-top flex-shrink-0 py-3",style:{position:"sticky",bottom:0,zIndex:1,backgroundColor:"#f8f9fa"},children:e.jsxs("div",{className:"d-flex justify-content-between w-100 align-items-center",children:[e.jsx("div",{children:p>1&&e.jsxs("button",{type:"button",onClick:()=>D(p-1),className:"btn btn-outline-secondary",style:{minWidth:"100px"},children:[e.jsx("i",{className:"fas fa-arrow-left me-2"}),"Previous"]})}),e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs("small",{className:"text-muted me-3",children:["Step ",p," of 3"]}),p<3?e.jsxs("button",{type:"button",onClick:()=>D(p+1),className:"btn btn-primary",style:{minWidth:"100px"},children:["Next",e.jsx("i",{className:"fas fa-arrow-right ms-2"})]}):e.jsx("button",{type:"button",onClick:G,disabled:P,className:"btn btn-success",style:{minWidth:"140px"},children:P?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Completing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-check me-2"}),"Complete Visit"]})})]})]})})]})})})}function Oe({visit:o,onClose:A}){var S,R;const[E,p]=l.useState(""),[D,$]=l.useState(!1),[T,r]=l.useState(""),[C,F]=l.useState(null),f=async b=>{var I,H;b.preventDefault(),$(!0),r("");try{const v=await u.post(`/api/visits/${o.id}/view-notes`,{password:E});F(v.data.notes)}catch(v){r(((H=(I=v==null?void 0:v.response)==null?void 0:I.data)==null?void 0:H.message)||"Invalid password or failed to decrypt notes")}finally{$(!1)}},P=b=>b?e.jsxs("div",{className:"space-y-4",children:[b.dentist_notes&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Dentist Notes:"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded border",children:e.jsx("p",{className:"whitespace-pre-wrap",children:b.dentist_notes})})]}),b.findings&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Findings:"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded border",children:e.jsx("p",{className:"whitespace-pre-wrap",children:b.findings})})]}),b.treatment_plan&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Treatment Plan:"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded border",children:e.jsx("p",{className:"whitespace-pre-wrap",children:b.treatment_plan})})]}),e.jsxs("div",{className:"text-sm text-gray-600 border-t pt-3",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Completed by:"})," Staff ID #",b.completed_by]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Completed at:"})," ",new Date(b.completed_at).toLocaleString()]})]})]}):null;return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",style:{padding:"1rem"},children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[calc(100vh-2rem)] flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 flex-shrink-0 sticky top-0 bg-white border-b z-10",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h2",{className:"text-xl font-bold",children:["Visit Notes - ",(S=o.patient)==null?void 0:S.first_name," ",(R=o.patient)==null?void 0:R.last_name]}),e.jsx("button",{onClick:A,className:"text-gray-500 hover:text-gray-700",children:"âœ•"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto overflow-x-hidden p-6",style:{minHeight:0},children:C?e.jsx("div",{children:P(C)}):e.jsxs("form",{onSubmit:f,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Enter your password to view encrypted notes:"}),e.jsx("input",{type:"password",className:"w-full border rounded px-3 py-2",value:E,onChange:b=>p(b.target.value),placeholder:"Enter your account password",required:!0}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"This action will be logged for security purposes."})]}),T&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded",children:T}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:A,className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:D||!E.trim(),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50",children:D?"Verifying...":"View Notes"})]})]})}),C&&e.jsx("div",{className:"p-6 flex-shrink-0 sticky bottom-0 bg-white border-t z-10",children:e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:A,className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:"Close"})})})]})})}function qe({visit:o,onClose:A,onSuccess:E}){var I,H,v;const[p,D]=l.useState([]),[$,T]=l.useState(!0),[r,C]=l.useState(null),[F,f]=l.useState(!1),[P,S]=l.useState("");l.useEffect(()=>{R()},[]);const R=async()=>{T(!0),S("");try{const m=new Date,y=m.getDay(),_=["sun","mon","tue","wed","thu","fri","sat"][y],O=(await u.get("/api/dentists",{params:{status:"active"}})).data.filter(N=>N[_]===!0&&N.status==="active"&&(!N.contract_end_date||new Date(N.contract_end_date)>=m));console.log("Available dentists:",O),D(O)}catch(m){console.error("Failed to fetch dentists:",m),S("Failed to load available dentists. Please try again.")}finally{T(!1)}},b=async()=>{var m,y;if(!r){S("Please select a dentist to send the visit code to.");return}if(!r.email){S("Selected dentist does not have an email address configured.");return}f(!0),S("");try{console.log("Sending visit code to dentist:",r);const g=await u.post("/api/visits/send-visit-code",{visit_id:o.id,dentist_id:r.id,dentist_email:r.email});alert(`Visit code sent successfully to Dr. ${r.dentist_name||r.dentist_code}!`),E&&E(r),A()}catch(g){console.error("Failed to send visit code:",g);let _="Failed to send visit code. Please try again.";(y=(m=g.response)==null?void 0:m.data)!=null&&y.message?_=g.response.data.message:g.message&&(_=g.message),S(_)}finally{f(!1)}};return e.jsx("div",{className:"modal show d-block",tabIndex:"-1",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1050,overflowY:"auto",display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem"},children:e.jsx("div",{className:"modal-dialog modal-lg",style:{margin:"0 auto",maxHeight:"calc(100vh - 2rem)",width:"100%"},children:e.jsxs("div",{className:"modal-content",style:{display:"flex",flexDirection:"column",maxHeight:"calc(100vh - 2rem)",overflow:"hidden"},children:[e.jsxs("div",{className:"modal-header flex-shrink-0",style:{position:"sticky",top:0,zIndex:1,backgroundColor:"#fff",borderBottom:"1px solid #dee2e6"},children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-send me-2"}),"Send Visit Code to Dentist"]}),e.jsx("button",{className:"btn-close",onClick:A,disabled:F})]}),e.jsxs("div",{className:"modal-body flex-grow-1",style:{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:0},children:[e.jsxs("div",{className:"alert alert-info mb-4",children:[e.jsxs("h6",{className:"alert-heading",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),"Visit Information"]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("strong",{children:"Patient:"})," ",(I=o.patient)==null?void 0:I.first_name," ",(H=o.patient)==null?void 0:H.last_name]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("strong",{children:"Visit Code:"}),e.jsx("span",{className:"badge bg-primary ms-2 fs-6",children:o.visit_code})]}),e.jsxs("div",{className:"col-md-6 mt-2",children:[e.jsx("strong",{children:"Service:"})," ",((v=o.service)==null?void 0:v.name)||"Not specified"]}),e.jsxs("div",{className:"col-md-6 mt-2",children:[e.jsx("strong",{children:"Started:"})," ",new Date(o.start_time).toLocaleString()]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"bi bi-person-badge me-2"}),"Select Available Dentist Today"]}),$?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"mt-2 text-muted",children:"Loading available dentists..."})]}):P&&!p.length?e.jsxs("div",{className:"alert alert-danger",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),P]}):p.length===0?e.jsxs("div",{className:"alert alert-warning",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"No dentists are scheduled to work today. Please check the dentist schedule."]}):e.jsx("div",{className:"row",children:p.map(m=>e.jsx("div",{className:"col-md-6 mb-3",children:e.jsx("div",{className:`card h-100 cursor-pointer border-2 ${(r==null?void 0:r.id)===m.id?"border-primary bg-light":"border-light"}`,style:{cursor:"pointer",transition:"all 0.2s ease"},onClick:()=>C(m),onMouseEnter:y=>{(r==null?void 0:r.id)!==m.id&&(y.target.style.borderColor="#0d6efd",y.target.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)")},onMouseLeave:y=>{(r==null?void 0:r.id)!==m.id&&(y.target.style.borderColor="#e9ecef",y.target.style.boxShadow="none")},children:e.jsx("div",{className:"card-body p-3",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("div",{className:"me-3",children:e.jsx("div",{className:"bg-primary text-white rounded-circle d-flex align-items-center justify-content-center",style:{width:"40px",height:"40px"},children:e.jsx("i",{className:"bi bi-person-fill"})})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("h6",{className:"card-title mb-1",children:["Dr. ",m.dentist_name||m.dentist_code]}),e.jsxs("small",{className:"text-muted",children:[m.dentist_code&&e.jsx("span",{className:"badge bg-secondary me-2",children:m.dentist_code}),m.employment_type&&e.jsx("span",{className:"text-capitalize",children:m.employment_type.replace("_"," ")})]}),m.email&&e.jsx("div",{className:"mt-1",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-envelope me-1"}),m.email]})})]}),(r==null?void 0:r.id)===m.id&&e.jsx("div",{className:"text-primary",children:e.jsx("i",{className:"bi bi-check-circle-fill fs-5"})})]})})})},m.id))})]}),P&&e.jsxs("div",{className:"alert alert-danger",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),P]})]}),e.jsxs("div",{className:"modal-footer flex-shrink-0",style:{position:"sticky",bottom:0,zIndex:1,backgroundColor:"#fff",borderTop:"1px solid #dee2e6"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:A,disabled:F,children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:b,disabled:F||!r||p.length===0,children:F?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-send me-2"}),"Send Visit Code"]})})]})]})})})}function Ze(){const[o,A]=l.useState([]),[E,p]=l.useState(!1),[D,$]=l.useState(!1),[T,r]=l.useState("walkin"),[C,F]=l.useState(""),[f,P]=l.useState(null),[S,R]=l.useState(!1),[b,I]=l.useState(""),[H,v]=l.useState(!1),[m,y]=l.useState(null),[g,_]=l.useState(""),[ee,O]=l.useState(!1),[N,V]=l.useState(null),[k,z]=l.useState({first_name:"",last_name:"",contact:"",service_id:""}),[te,Q]=l.useState([]),[pe,Z]=l.useState(!1),[K,se]=l.useState(""),[G,Y]=l.useState([]),[W,L]=l.useState(null),[X,q]=l.useState(!1),[ae,le]=l.useState(null),[ie,ne]=l.useState(null),[ce,re]=l.useState(null),[i,j]=l.useState(null),[h,d]=l.useState([]),[Se,de]=l.useState(!1),[ke,me]=l.useState(!1),[a,M]=l.useState({patient_id:"",first_name:"",last_name:"",contact_number:"",email:"",birthdate:"",service_id:"",date:"",start_time:"",payment_method:"cash",patient_hmo_id:"",teeth_count:"",linkToExisting:!1}),[be,J]=l.useState([]),[Ce,je]=l.useState(!1),[fe,ge]=l.useState(!1),[w,ue]=l.useState(null),[oe,he]=l.useState([]),[Pe,Ne]=l.useState(!1);l.useEffect(()=>{U()},[]),l.useEffect(()=>{console.log("ðŸ”„ Visits state updated:",o),console.log("ðŸ“Š Visit counts:",{total:o.length,pending:o.filter(t=>t.status==="pending").length,completed:o.filter(t=>t.status==="completed").length,rejected:o.filter(t=>t.status==="rejected").length})},[o]);const U=async()=>{p(!0);try{console.log("ðŸŒ Fetching visits from API...");const t=await u.get("/api/visits");console.log("ðŸ“¥ API response received:",t.data),console.log("ðŸ“ˆ Number of visits received:",t.data.length),console.log("â³ Visits with pending status:",t.data.filter(s=>s.status==="pending")),console.log("ðŸ” Visit IDs:",t.data.map(s=>{var n,c;return{id:s.id,status:s.status,patient:((n=s.patient)==null?void 0:n.first_name)+" "+((c=s.patient)==null?void 0:c.last_name)}})),A(t.data)}catch(t){console.error("âŒ Failed to load visits",t)}finally{p(!1)}},Me=async()=>{var t,s;$(!0);try{let n;if(T==="walkin")n={visit_type:"walkin"};else if(T==="appointment"){if(!f){alert("Search and select a valid appointment first."),$(!1);return}n={visit_type:"appointment",reference_code:(C||"").toUpperCase().replace(/[^A-Z0-9]/g,"")}}console.log("ðŸš€ Creating visit with payload:",n);const x=(await u.post("/api/visits",n)).data;console.log("âœ… Visit created successfully:",x),console.log("ðŸ“‹ Visit details:",{id:x.id,status:x.status,visit_code:x.visit_code,patient_id:x.patient_id,patient_name:((t=x.patient)==null?void 0:t.first_name)+" "+((s=x.patient)==null?void 0:s.last_name),start_time:x.start_time}),x.visit_code&&alert(`Visit started successfully!

Visit Code: ${x.visit_code}

Share this code with the dentist to begin consultation.`),console.log("âž• Adding new visit to state:",x),A(B=>{const xe=[x,...B];return console.log("ðŸ”„ Updated visits state with new visit:",xe),console.log("ðŸŽ¯ New visit should now be visible in the list"),xe}),F(""),P(null),console.log("ðŸ”„ Fetching visits after creation to ensure consistency..."),await new Promise(B=>setTimeout(B,200)),await U(),console.log("âœ… Visit creation process completed")}catch(n){console.error("Error creating visit:",n),alert("Failed to start visit.")}finally{$(!1)}},Ae=async(t,s)=>{{const n=o.find(c=>c.id===t);if(!n.service_id){alert("Please select a service for this patient before finishing the visit. Use the 'Edit' button to assign a service.");return}le(n);return}},Ie=async()=>{await U()},Te=async t=>{var s,n;re(t);try{const c=await u.post(`/api/receipts/visit/${t}/email`,{},{skip401Handler:!0});c.data.note?alert(`${c.data.message}

${c.data.note}`):alert(`Receipt sent successfully to ${c.data.email}`)}catch(c){console.error("Failed to send receipt email",c);const x=((n=(s=c.response)==null?void 0:s.data)==null?void 0:n.message)||"Failed to send receipt email. Please try again.";alert(x)}finally{re(null)}},Ve=async()=>{R(!0),P(null),I("");try{const t=(C||"").toUpperCase().replace(/[^A-Z0-9]/g,"");if(t.length!==8){I("Enter the full 8-character code.");return}const s=await u.get(`/api/appointment/resolve/${t}`);P(s.data)}catch{I("Invalid or used reference code.")}finally{R(!1)}},Fe=async t=>{var s,n,c;V(t),z({first_name:((s=t.patient)==null?void 0:s.first_name)||"",last_name:((n=t.patient)==null?void 0:n.last_name)||"",contact:((c=t.patient)==null?void 0:c.contact)||"",service_id:t.service_id||""});try{const x=new Date().toISOString().slice(0,10),B=await u.get(`/api/appointment/available-services?date=${x}`);Q(Array.isArray(B.data)?B.data:B.data.data||[])}catch{alert("Failed to load services.")}},Le=async()=>{var t;try{const s=await u.put(`/api/visits/${N.id}/update-patient`,{first_name:k.first_name,last_name:k.last_name,contact_number:k.contact.trim()!==""?k.contact.trim():(t=N.patient)==null?void 0:t.contact_number,service_id:k.service_id||null});s.data.potential_matches&&s.data.potential_matches.length>0?(d(s.data.potential_matches),de(!0)):V(null),await U()}catch{alert("Failed to update patient.")}},Ee=async()=>{M({patient_id:"",first_name:"",last_name:"",contact_number:"",email:"",birthdate:"",service_id:"",date:"",start_time:"",payment_method:"cash",patient_hmo_id:"",teeth_count:"",linkToExisting:!1}),ue(null),J([]),he([]),Q([]),me(!0)},De=async t=>{if(M(s=>({...s,date:t,start_time:"",service_id:""})),J([]),ue(null),t){Ne(!0);try{const s=await u.get(`/api/dentists/available-for-date?date=${t}`);he(s.data.dentists||[])}catch(s){console.error("Failed to load dentists for date:",s),he([])}finally{Ne(!1)}try{const s=await u.get(`/api/appointment/available-services?date=${t}`);Q(Array.isArray(s.data)?s.data:s.data.data||[])}catch(s){console.error("Failed to load services for new date:",s),Q([])}}else he([]),Q([])},$e=async t=>{const s=te.find(n=>n.id==t);ue(s),M(n=>({...n,service_id:t,start_time:"",teeth_count:""})),J([]),t&&a.date&&s&&!s.per_teeth_service&&await ye(a.date,t,a.teeth_count)},ve=async t=>{M(s=>({...s,teeth_count:t,start_time:""})),J([]),a.date&&a.service_id&&t&&t>0&&await ye(a.date,a.service_id,t)},ye=async(t,s,n=null)=>{je(!0);try{const c={date:t,service_id:s};n&&(c.teeth_count=n);const x=await u.get("/api/appointment/available-slots",{params:c});J(x.data.slots||x.data)}catch(c){console.error("Failed to fetch available slots:",c),J([])}finally{je(!1)}},_e=t=>{if(!t)return null;const s=new Date(t),n=new Date,c=new Date;return c.setFullYear(n.getFullYear()-4),s>n?"Birthdate cannot be in the future.":s>c?"Patient must be at least 4 years old.":null},we=()=>{const t=new Date;return t.setFullYear(t.getFullYear()-4),t.toISOString().split("T")[0]},Re=async()=>{var s,n;if(!a.service_id||!a.date||!a.start_time){alert("Please select service, date, and time.");return}if(w&&w.per_teeth_service&&!a.teeth_count){alert("Please enter the number of teeth for this per-teeth service.");return}const t=_e(a.birthdate);if(t){alert(t);return}if(!a.linkToExisting&&(!a.first_name||!a.last_name||!a.contact_number)){alert("Please fill in patient details including contact number (required for SMS reminders) or link to existing patient.");return}if(a.linkToExisting&&!a.patient_id){alert("Please select an existing patient.");return}ge(!0);try{const c={service_id:a.service_id,date:a.date,start_time:a.start_time,payment_method:a.payment_method};a.linkToExisting?c.patient_id=a.patient_id:(c.first_name=a.first_name,c.last_name=a.last_name,c.contact_number=a.contact_number,a.email&&(c.email=a.email),a.birthdate&&(c.birthdate=a.birthdate)),a.payment_method==="hmo"&&a.patient_hmo_id&&(c.patient_hmo_id=a.patient_hmo_id),a.teeth_count&&(c.teeth_count=parseInt(a.teeth_count));const x=await u.post("/api/appointments/staff-create",c);alert(`Appointment created successfully!
Reference Code: ${x.data.appointment.reference_code}`),me(!1)}catch(c){const x=((n=(s=c.response)==null?void 0:s.data)==null?void 0:n.message)||"Failed to create appointment.";alert(x)}finally{ge(!1)}};return e.jsxs("div",{className:"h-100 d-flex flex-column",children:[e.jsx("h3",{children:"ðŸ“ Patient Visit Tracker"}),e.jsxs("div",{className:"card p-3 mb-4",children:[e.jsx("label",{children:"Visit Type"}),e.jsxs("select",{className:"form-select mb-2",value:T,onChange:t=>{r(t.target.value),P(null),F(""),I("")},children:[e.jsx("option",{value:"walkin",children:"Walk-in"}),e.jsx("option",{value:"appointment",children:"Appointment"})]}),T==="appointment"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"input-group mb-2",children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Enter Appointment Reference Code",value:C,onChange:t=>F(t.target.value.toUpperCase())}),e.jsx("button",{className:"btn btn-outline-primary",onClick:Ve,disabled:S||!C,children:S?"Searching...":"Search"})]}),b&&e.jsx("div",{className:"text-danger",children:b}),f&&e.jsxs("div",{className:"alert alert-success",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:f.patient_name})," â€”"," ",f.service_name," @ ",f.date," /"," ",f.time_slot]}),f.last_visit&&e.jsxs("div",{className:"mt-2 p-2 bg-light rounded",children:[e.jsx("small",{className:"text-muted",children:"ðŸ“‹ Last Visit:"}),e.jsxs("div",{className:"small",children:[e.jsx("strong",{children:"Date:"})," ",new Date(f.last_visit.visit_date).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})," |"," ",e.jsx("strong",{children:"Service:"})," ",f.last_visit.service_name||"N/A",f.last_visit.teeth_treated&&e.jsxs(e.Fragment,{children:[" | ",e.jsx("strong",{children:"Teeth Treated:"})," ",f.last_visit.teeth_treated]})]})]}),!f.last_visit&&e.jsx("div",{className:"mt-2 p-2 bg-light rounded",children:e.jsx("small",{className:"text-muted",children:"ðŸ“‹ No previous visits found"})})]})]}),e.jsxs("div",{className:"d-flex gap-2 mt-2",children:[e.jsx("button",{className:"btn btn-primary",onClick:Me,disabled:D,children:D?"Saving...":"Start Visit"}),e.jsx("button",{className:"btn btn-success",onClick:Ee,children:"ðŸ“… Make Appointment"})]})]}),e.jsxs("div",{className:"flex-grow-1 d-flex flex-column",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:["Ongoing Visits (",o.length," total, ",o.filter(t=>t.status==="pending").length," pending)"]}),E&&e.jsxs("div",{className:"d-flex align-items-center text-muted ms-3",children:[e.jsx("div",{className:"spinner-border spinner-border-sm me-2",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("small",{children:"Loading visits..."})]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:U,children:"ðŸ”„ Refresh"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>q(t=>!t),children:X?"ðŸ”½ Hide Completed/Rejected":"ðŸ”¼ Show All Today's Visits"})]})]}),e.jsx("div",{className:"table-responsive flex-grow-1",children:e.jsxs("table",{className:"table table-bordered table-hover mb-0",children:[e.jsx("thead",{className:"table-light sticky-top",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Contact"}),e.jsx("th",{children:"Visit Code"}),e.jsx("th",{children:"Service"}),e.jsx("th",{children:"Note"}),e.jsx("th",{children:"Started At"}),e.jsx("th",{children:"Status"}),e.jsx("th",{style:{minWidth:"200px"},children:"Actions"})]})}),e.jsx("tbody",{children:(()=>{const t=o.filter(s=>X||s.status==="pending");return console.log("All visits:",o),console.log("Show all visits:",X),console.log("Filtered visits:",t),t})().map(t=>{var s,n,c;return console.log("Rendering visit:",t.id,"Patient:",t.patient),e.jsxs("tr",{children:[e.jsxs("td",{children:[(s=t.patient)==null?void 0:s.first_name," ",(n=t.patient)==null?void 0:n.last_name]}),e.jsx("td",{children:((c=t.patient)==null?void 0:c.contact_number)||"â€”"}),e.jsx("td",{children:t.visit_code?e.jsx("span",{className:"badge bg-primary",children:t.visit_code}):"â€”"}),e.jsx("td",{children:t.service?e.jsx("span",{className:"badge bg-info",children:t.service.name}):e.jsxs("span",{className:"badge bg-warning",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-1"}),"No Service"]})}),e.jsx("td",{children:t.status==="completed"&&t.visit_notes?e.jsx("button",{className:"btn btn-sm btn-outline-info",onClick:()=>ne(t),children:"ðŸ”’ View Notes"}):"â€”"}),e.jsx("td",{children:t.start_time?new Date(t.start_time).toLocaleString("en-PH",{dateStyle:"medium",timeStyle:"short"}):"â€”"}),e.jsx("td",{children:t.status}),e.jsxs("td",{children:[t.status==="pending"&&e.jsxs("div",{className:"d-flex gap-1 flex-wrap",children:[e.jsx("button",{className:`btn btn-sm ${t.service_id?"btn-success":"btn-outline-secondary"}`,onClick:()=>Ae(t.id),disabled:!t.service_id,title:t.service_id?"Complete this visit":"Please select a service first",children:t.service_id?"Finish":e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-1"}),"Finish"]})}),e.jsxs("button",{className:"btn btn-info btn-sm",onClick:()=>j(t),title:"Send visit code to available dentist",children:[e.jsx("i",{className:"bi bi-send me-1"}),"Send Code"]}),e.jsx("button",{className:"btn btn-warning btn-sm",onClick:()=>Fe(t),children:"Edit"}),e.jsx("button",{className:"btn btn-danger btn-sm",onClick:()=>{y(t.id),_(""),O(!1),v(!0)},children:"Reject"})]}),t.status==="completed"&&e.jsx("div",{className:"d-flex gap-1 flex-wrap",children:e.jsx("button",{className:"btn btn-success btn-sm",onClick:()=>Te(t.id),disabled:ce===t.id,title:"Send Receipt Email",children:ce===t.id?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-envelope me-1"}),"Send Receipt"]})})})]})]},t.id)})})]})})]}),H&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:g==="inquiry_only"?"Mark as Inquiry":"Reject Visit"}),e.jsx("button",{className:"btn-close",onClick:()=>v(!1)})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("label",{className:"form-label",children:g==="inquiry_only"?"Reason for inquiry:":"Reason for rejection:"}),e.jsxs("select",{className:"form-select",value:g,onChange:t=>_(t.target.value),children:[e.jsx("option",{value:"",children:"Select reason"}),e.jsx("option",{value:"human_error",children:"Human Error"}),e.jsx("option",{value:"left",children:"Patient Left"}),e.jsx("option",{value:"line_too_long",children:"Line Too Long"}),e.jsx("option",{value:"inquiry_only",children:"Inquiry Only"})]}),g==="line_too_long"&&e.jsxs("div",{className:"form-check mt-2",children:[e.jsx("input",{type:"checkbox",className:"form-check-input",checked:ee,onChange:t=>O(t.target.checked),id:"offerAppt"}),e.jsx("label",{htmlFor:"offerAppt",className:"form-check-label",children:"Patient was offered an appointment"})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>v(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-danger",disabled:!g,onClick:async()=>{await u.post(`/api/visits/${m}/reject`,{reason:g,offered_appointment:ee}),v(!1),y(null),await U()},children:g==="inquiry_only"?"Mark as Inquiry":"Confirm Reject"})]})]})})}),N&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Edit Patient Info"}),e.jsx("button",{className:"btn-close",onClick:()=>V(null)})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("label",{className:"form-label",children:"First Name"}),e.jsx("input",{className:"form-control mb-2",value:k.first_name,onChange:t=>z({...k,first_name:t.target.value})}),e.jsx("label",{className:"form-label",children:"Last Name"}),e.jsx("input",{className:"form-control mb-2",value:k.last_name,onChange:t=>z({...k,last_name:t.target.value})}),e.jsx("label",{className:"form-label",children:"Contact"}),e.jsx("input",{className:"form-control mb-2",value:k.contact,onChange:t=>z({...k,contact:t.target.value})}),e.jsx("label",{className:"form-label",children:"Service"}),e.jsxs("select",{className:"form-select",value:k.service_id,onChange:t=>z({...k,service_id:t.target.value}),children:[e.jsx("option",{value:"",children:"â€” Select â€”"}),te.map(t=>e.jsxs("option",{value:t.id,children:[t.name," â€“"," ",t.type==="promo"?`â‚±${Number(t.promo_price).toLocaleString()} (${t.discount_percent}% off)`:t.type==="special"?`â‚±${Number(t.price).toLocaleString()} Special Service`:`â‚±${Number(t.price).toLocaleString()}`]},t.id))]}),e.jsx("hr",{}),e.jsx("button",{className:"btn btn-outline-secondary",onClick:()=>{Z(!0),se(""),Y([]),L(null)},children:"ðŸ”— Link to Existing Patient"})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>V(null),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:Le,children:"Save"})]})]})})}),pe&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Link to Existing Patient"}),e.jsx("button",{className:"btn-close",onClick:()=>Z(!1)})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("input",{className:"form-control mb-2",placeholder:"Search by name or contact (min 2 characters)",value:K,onChange:async t=>{const s=t.target.value;if(se(s),Y([]),L(null),s.length>=2)try{const n=await u.get("/api/patients/search",{params:{q:s.trim()}});Y(n.data)}catch{alert("Search failed.")}}}),G.filter(t=>{var s;return t.id!==((s=N==null?void 0:N.patient)==null?void 0:s.id)}).length>0?e.jsxs("table",{className:"table table-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Contact"}),e.jsx("th",{children:"Birthdate"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:G.filter(t=>{var s;return t.id!==((s=N==null?void 0:N.patient)==null?void 0:s.id)}).map(t=>e.jsxs("tr",{children:[e.jsxs("td",{children:[t.first_name," ",t.last_name]}),e.jsx("td",{children:t.contact_number||"â€”"}),e.jsx("td",{children:t.birthdate||"â€”"}),e.jsx("td",{children:e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>L(t),children:"Select"})})]},t.id))})]}):e.jsxs("table",{className:"table table-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Contact"}),e.jsx("th",{children:"Birthdate"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"text-muted text-center",children:"No matching patients found."})})})]}),W&&e.jsxs("div",{className:"alert alert-info mt-3",children:["Link current visit to"," ",e.jsxs("strong",{children:[W.first_name," ",W.last_name]}),"?"]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>Z(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",disabled:!W,onClick:async()=>{try{await u.post(`/api/visits/${N.id}/link-existing`,{target_patient_id:W.id}),Z(!1),V(null),await U()}catch{alert("Failed to link to patient.")}},children:"Confirm Link"})]})]})})}),Se&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header bg-warning",children:[e.jsx("h5",{className:"modal-title",children:"âš ï¸ Potential Duplicate Patient Found"}),e.jsx("button",{className:"btn-close",onClick:()=>{de(!1),V(null)}})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"alert alert-warning",children:[e.jsx("strong",{children:"Warning:"})," We found existing patient(s) with the same name. This might be a duplicate entry. Please review and link if this is the same patient."]}),e.jsx("h6",{children:"Matching Patients:"}),h.map(t=>e.jsx("div",{className:"card mb-2 p-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsxs("strong",{children:[t.first_name," ",t.last_name]}),e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["Contact: ",t.contact_number||"N/A",e.jsx("br",{}),"Birthdate: ",t.birthdate?new Date(t.birthdate).toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"}):"N/A",e.jsx("br",{}),t.has_user_account&&e.jsxs("span",{className:"badge bg-success",children:["Has Online Account (",t.user_email,")"]})]})]}),e.jsx("button",{className:"btn btn-primary",onClick:async()=>{if(window.confirm(`Link this visit to ${t.first_name} ${t.last_name}?`))try{await u.post(`/api/visits/${N.id}/link-existing`,{target_patient_id:t.id}),de(!1),V(null),await U(),alert("Visit successfully linked to existing patient!")}catch{alert("Failed to link visit to patient.")}},children:"Link to This Patient"})]})},t.id)),e.jsx("hr",{}),e.jsx("p",{className:"text-muted",children:e.jsx("small",{children:"If none of these patients match, you can close this dialog and the walk-in patient record will remain separate."})})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-secondary",onClick:()=>{de(!1),V(null)},children:"Keep as Separate Patient"})})]})})}),ae&&e.jsx(He,{visit:ae,onClose:()=>le(null),onComplete:Ie}),ie&&e.jsx(Oe,{visit:ie,onClose:()=>ne(null)}),i&&e.jsx(qe,{visit:i,onClose:()=>j(null),onSuccess:t=>{console.log(`Visit code sent to Dr. ${t.dentist_name||t.dentist_code}`)}}),ke&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"ðŸ“… Create Appointment for Walk-in Patient"}),e.jsx("button",{className:"btn-close",onClick:()=>me(!1)})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("h6",{children:"Patient Information"}),e.jsxs("div",{className:"form-check mb-3",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"linkToExisting",checked:a.linkToExisting,onChange:t=>M(s=>({...s,linkToExisting:t.target.checked,patient_id:t.target.checked?s.patient_id:"",first_name:t.target.checked?"":s.first_name,last_name:t.target.checked?"":s.last_name,contact_number:t.target.checked?"":s.contact_number,email:t.target.checked?"":s.email,birthdate:t.target.checked?"":s.birthdate}))}),e.jsx("label",{className:"form-check-label",htmlFor:"linkToExisting",children:"Link to existing patient"})]}),a.linkToExisting?e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Search Existing Patient"}),e.jsx("input",{className:"form-control",placeholder:"Search by name or contact (min 2 characters)",value:K,onChange:async t=>{const s=t.target.value;if(se(s),Y([]),L(null),s.length>=2)try{const n=await u.get("/api/patients/search",{params:{q:s.trim()}});Y(n.data)}catch{alert("Search failed.")}}}),G.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("small",{className:"text-muted",children:"Select a patient:"}),G.map(t=>e.jsx("div",{className:"card p-2 mb-1 cursor-pointer",onClick:()=>{M(s=>({...s,patient_id:t.id})),L(t)},style:{cursor:"pointer",backgroundColor:a.patient_id===t.id?"#e3f2fd":"white"},children:e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{children:[e.jsxs("strong",{children:[t.first_name," ",t.last_name]}),e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["Contact: ",t.contact_number||"N/A"," | Birthdate: ",t.birthdate?new Date(t.birthdate).toLocaleDateString():"N/A"]})]}),a.patient_id===t.id&&e.jsx("span",{className:"badge bg-primary",children:"Selected"})]})},t.id))]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"First Name *"}),e.jsx("input",{className:"form-control",value:a.first_name,onChange:t=>M(s=>({...s,first_name:t.target.value}))})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Last Name *"}),e.jsx("input",{className:"form-control",value:a.last_name,onChange:t=>M(s=>({...s,last_name:t.target.value}))})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Contact Number *"}),e.jsx("input",{className:"form-control",value:a.contact_number,onChange:t=>M(s=>({...s,contact_number:t.target.value})),placeholder:"Required for SMS reminders"}),e.jsxs("div",{className:"form-text",children:[e.jsx("i",{className:"bi bi-phone me-1"}),"Required for SMS appointment reminders"]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Email (Optional)"}),e.jsx("input",{type:"email",className:"form-control",value:a.email,onChange:t=>M(s=>({...s,email:t.target.value}))})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Birthdate (Optional)"}),e.jsx("input",{type:"date",className:"form-control",value:a.birthdate,onChange:t=>{const s=t.target.value;M(c=>({...c,birthdate:s}));const n=_e(s);n&&alert(n)},max:we()}),e.jsxs("div",{className:"form-text",children:["Must be at least 4 years old (dates after ",we()," are not selectable)."]})]})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("h6",{children:"Appointment Details"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-control",value:a.date,onChange:t=>De(t.target.value),min:new Date().toISOString().slice(0,10),max:new Date(Date.now()+7*24*60*60*1e3).toISOString().slice(0,10),placeholder:"Select a date"}),e.jsxs("div",{className:"form-text",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),a.date?"You can only select dates up to 7 days from today":"Please select a date first to see available dentists and services"]})]}),a.date&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Available Dentists"}),Pe?e.jsxs("div",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-hourglass-split me-1"}),"Loading available dentists..."]}):oe.length>0?e.jsxs("div",{className:"alert alert-info border-0 shadow-sm",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("div",{children:[e.jsx("i",{className:"bi bi-person-check me-2"}),e.jsxs("strong",{children:[oe.length," dentist",oe.length!==1?"s":""," available"]})]}),e.jsx("span",{className:"badge bg-primary",children:oe.length})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("small",{className:"text-muted",children:"Available dentists:"}),e.jsx("div",{className:"mt-1",children:oe.map((t,s)=>e.jsxs("span",{className:"badge bg-light text-dark me-1 mb-1",children:[t.dentist_name," (",t.dentist_code,")"]},s))})]})]}):e.jsxs("div",{className:"alert alert-warning border-0 shadow-sm",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"No dentists available on this date"]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Service *"}),e.jsxs("select",{className:"form-select",value:a.service_id,onChange:t=>$e(t.target.value),disabled:!a.date,children:[e.jsx("option",{value:"",children:a.date?"Select a service":"Please select a date first"}),te.map(t=>e.jsxs("option",{value:t.id,children:[t.name," â€“"," ",t.type==="promo"?`â‚±${Number(t.promo_price).toLocaleString()} (${t.discount_percent}% off)`:t.type==="special"?`â‚±${Number(t.price).toLocaleString()} Special Service`:`â‚±${Number(t.price).toLocaleString()}`,t.per_teeth_service?" per tooth":""]},t.id))]}),!a.date&&e.jsxs("div",{className:"form-text text-muted",children:[e.jsx("i",{className:"bi bi-lock me-1"}),"Please select a date first to enable service selection"]})]}),w&&e.jsx("div",{className:"alert alert-info border-0 shadow-sm mb-4",role:"alert",children:e.jsx("div",{className:"d-flex align-items-center justify-content-between flex-wrap",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("i",{className:"bi bi-check-circle me-3 fs-4"}),e.jsxs("div",{children:[e.jsx("strong",{children:"Service Selected:"}),e.jsx("br",{}),e.jsx("span",{className:"fs-5",children:w.name}),e.jsx("br",{}),e.jsxs("span",{className:"text-info fw-semibold",children:["â‚±",Number(w.price||w.promo_price).toLocaleString(),w.per_teeth_service?" per tooth":""]}),w.per_teeth_service&&e.jsx("div",{className:"mt-2",children:e.jsxs("small",{className:"text-info",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Total cost depends on number of teeth treated"]})})]})]})})}),w&&w.per_teeth_service&&e.jsx("div",{className:"alert alert-warning border-0 shadow-sm mb-4",role:"alert",children:e.jsxs("div",{className:"d-flex align-items-start",children:[e.jsx("i",{className:"bi bi-lightbulb me-3 fs-4 text-warning"}),e.jsxs("div",{children:[e.jsxs("h6",{className:"alert-heading text-warning mb-2",children:[e.jsx("i",{className:"bi bi-tooth me-2"}),"Per-Teeth Service Information"]}),e.jsx("p",{className:"mb-2",children:"For per-teeth services, please enter the number of teeth that need treatment. This will determine:"}),e.jsxs("ul",{className:"mb-2 ps-3",children:[e.jsx("li",{children:"Appointment duration"}),e.jsx("li",{children:"Available time slots"}),e.jsx("li",{children:"Accurate cost calculation"})]})]})]})}),w&&w.per_teeth_service&&e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-label",children:["Number of Teeth to be Treated *",e.jsx("span",{className:"text-muted ms-1",children:"(Required for per-teeth services)"})]}),e.jsxs("div",{className:"position-relative",children:[e.jsx("input",{type:"number",min:"1",max:"32",className:"form-control",value:a.teeth_count,onChange:t=>{const s=t.target.value;(s===""||parseInt(s)>=1&&parseInt(s)<=32)&&ve(s)},placeholder:"Select or enter number of teeth",style:{paddingRight:"60px"}}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2",onClick:()=>{const t=document.getElementById("teethCountModal");t&&(new bootstrap.Modal(t).show(),setTimeout(()=>{const n=t.querySelector(".teeth-roulette"),c=t.querySelector(`[data-teeth="${a.teeth_count}"]`);if(n&&c&&a.teeth_count){const x=c.offsetTop,B=n.clientHeight,xe=c.clientHeight;n.scrollTop=x-B/2+xe/2}},300))},style:{height:"32px",width:"40px",padding:"0"},children:e.jsx("i",{className:"bi bi-chevron-down"})})]}),e.jsx("div",{className:"modal fade",id:"teethCountModal",tabIndex:"-1","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-tooth me-2"}),"Select Number of Teeth"]}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body p-0",children:e.jsx("div",{className:"teeth-roulette",style:{height:"200px",overflowY:"auto",padding:"10px",scrollBehavior:"smooth",touchAction:"pan-y",WebkitOverflowScrolling:"touch"},onScroll:t=>{t.target.scrollTop=Math.round(t.target.scrollTop/50)*50},onTouchStart:t=>{t.target.style.backgroundColor="#f8f9fa"},onTouchEnd:t=>{setTimeout(()=>{t.target.style.backgroundColor="transparent"},150)},children:Array.from({length:32},(t,s)=>s+1).map(t=>e.jsx("div",{"data-teeth":t,className:`teeth-option d-flex align-items-center justify-content-center p-3 border-bottom cursor-pointer ${a.teeth_count==t?"bg-primary text-white":"bg-light"}`,onClick:()=>{ve(t.toString());const s=document.getElementById("teethCountModal");s&&bootstrap.Modal.getInstance(s).hide()},style:{minHeight:"50px",cursor:"pointer",transition:"all 0.2s ease",userSelect:"none"},onMouseEnter:s=>{a.teeth_count!=t&&(s.target.style.backgroundColor="#e9ecef")},onMouseLeave:s=>{a.teeth_count!=t&&(s.target.style.backgroundColor="#f8f9fa")},children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"fs-4 fw-bold",children:t}),e.jsx("div",{className:"small",children:t===1?"tooth":"teeth"}),a.teeth_count==t&&e.jsx("div",{className:"small",children:e.jsx("i",{className:"bi bi-check-circle-fill"})})]})},t))})}),e.jsx("div",{className:"modal-footer",children:e.jsx("div",{className:"w-100 text-center",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Swipe to scroll â€¢ Tap to select â€¢ Max 32 teeth"]})})})]})})}),e.jsxs("div",{className:"form-text",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Enter the number of teeth that need treatment. Time slots will be calculated based on this.",a.teeth_count&&e.jsxs("div",{className:"mt-1",children:[e.jsx("strong",{children:"Estimated cost:"})," â‚±",Number(w.price||w.promo_price)*parseInt(a.teeth_count||0).toLocaleString()]})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Time Slot *"}),Ce?e.jsx("div",{className:"text-muted",children:"Loading available slots..."}):be.length>0?e.jsxs("select",{className:"form-select",value:a.start_time,onChange:t=>M(s=>({...s,start_time:t.target.value})),children:[e.jsx("option",{value:"",children:"Select time slot"}),be.map(t=>e.jsx("option",{value:t,children:t},t))]}):a.service_id&&a.date?e.jsx("div",{className:"text-muted",children:w&&w.per_teeth_service&&!a.teeth_count?"Please enter number of teeth first to see available time slots.":"No available slots for this service on this date."}):e.jsx("div",{className:"text-muted",children:a.date?a.service_id?"Please select service and date first.":"Please select a service first.":"Please select a date first."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Payment Method *"}),e.jsxs("select",{className:"form-select",value:a.payment_method,onChange:t=>M(s=>({...s,payment_method:t.target.value})),disabled:!a.date||!a.service_id,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"maya",children:"Maya Payment"}),e.jsx("option",{value:"hmo",children:"HMO"})]}),(!a.date||!a.service_id)&&e.jsxs("div",{className:"form-text text-muted",children:[e.jsx("i",{className:"bi bi-lock me-1"}),"Please select date and service first to enable payment method selection"]})]}),a.payment_method==="hmo"&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"HMO (Optional)"}),e.jsx("select",{className:"form-select",value:a.patient_hmo_id,onChange:t=>M(s=>({...s,patient_hmo_id:t.target.value})),children:e.jsx("option",{value:"",children:"No HMO selected"})})]})]})]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>me(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:Re,disabled:fe,children:fe?"Creating...":"Create Appointment"})]})]})})})]})}export{Ze as default};
